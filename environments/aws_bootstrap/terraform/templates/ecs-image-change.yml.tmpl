# Created by Terraform Bootstrap

name: Redeploy latest image to ECS

on:
  workflow_run:
    workflows: ["CI / Docker Build"]
    types:
      - completed

jobs:
  deploy:
    if: $${{ github.event.workflow_run.conclusion == 'success' }} && $${{ github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${role_arn}
          aws-region: ${region}

%{ for env in envs ~}
      - name: Fetch ECS config
        if: github.ref == 'refs/heads/${env.branch}'
        run: |
          aws ssm get-parameter --name "/cd/${env.prefix}/config" \
            --with-decryption --query "Parameter.Value" --output text > ecs.json

      - name: Force new ECS config
        if: github.ref == 'refs/heads/${env.branch}'
        run: |
          CLUSTER=$(jq -r '.cluster' ecs.json)
          SERVICE=$(jq -r '.service' ecs.json)
          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$SERVICE" \
            --force-new-deployment
            
%{ endfor ~}